const $grid=$(".datosMultiple").isotope({itemSelector:".mix",layoutMode:"fitRows",getSortData:{nombre:"[data-nombre]",edad:"[data-edad] parseInt",unidad:"[data-unidad]"}});function getFiltroClaseActual(){const e=$("#registros").val();return"1"==e?".unidad":"2"==e?".mios":"*"}function aplicarFiltros(){const e=$("#searchAsociado").val().toLowerCase(),o=getFiltroClaseActual();$grid.isotope({filter:function(){const i=$(this);if("*"!==o&&!i.is(o))return!1;if(!e)return!0;const a=i.data("nombre")?.toString().toLowerCase()||"",n=i.data("apellidos")?.toString().toLowerCase()||"",t=i.data("edad")?.toString().toLowerCase()||"",r=i.data("padre-nombre")?.toString().toLowerCase()||"",d=i.data("padre-apellidos")?.toString().toLowerCase()||"",l=i.data("padre-correo")?.toString().toLowerCase()||"",s=i.data("padre-telefono")?.toString().toLowerCase()||"",c=i.data("unidad")?.toString().toLowerCase()||"";return a.includes(e)||n.includes(e)||t.includes(e)||r.includes(e)||d.includes(e)||l.includes(e)||s.includes(e)||c.includes(e)}}),setTimeout((()=>{const e=$grid.data("isotope").filteredItems.length;$("#sinResultados").toggle(0===e),$("#ordenar").prop("disabled",0===e),0===e?$("#ordenar option:first").text("Sin resultados para ordenar"):$("#ordenar option:first").text("Ordenar por:")}),100)}function toggleRamaOptions(e){const o=$('#ordenar option[value="5"], #ordenar option[value="6"], #ordenar option[value="7"], #ordenar option[value="8"]');e?o.show():o.hide()}function cargarLoader(){return'\n        <div id="loaderEdit">\n            <div class="leap-frog">\n                <div class="leap-frog__dot"></div>\n                <div class="leap-frog__dot"></div>\n                <div class="leap-frog__dot"></div>\n            </div>\n        </div>\n    '}function debounce(e,o){let i;return function(...a){clearTimeout(i),i=setTimeout((()=>e.apply(this,a)),o)}}function loadAddresses(e,o,i){const a={allowClear:!0,dropdownCssClass:"select2-dropdown-up",minimumResultsForSearch:0,width:"100%",dropdownAutoWidth:!0,position:"absolute"};$("#inputComunidad").select2({placeholder:"Selecciona una Comunidad Autónoma",...a}),$("#inputProvincia").select2({placeholder:"Selecciona una Provincia",...a}),$("#inputMunicipio").select2({placeholder:"Selecciona un Municipio",...a}),$("#inputComunidad").on("change",debounce((function(){const e=$(this).val();e?(loadProvincias(e),$("#inputMunicipio").empty().trigger("change.select2")):(loadComunidades(),$("#inputProvincia").empty().trigger("change.select2"),$("#inputMunicipio").empty().trigger("change.select2"))}),500)),$("#inputProvincia").on("change",debounce((function(){const e=$(this).val(),o=$("#inputComunidad").val();e?loadMunicipios(e):o?(loadProvincias(o),$("#inputMunicipio").empty().trigger("change.select2")):$("#inputMunicipio").empty().trigger("change.select2")}),500)),loadComunidades(e),loadProvincias(e,o),loadMunicipios(o,i),document.getElementById("editForm").style.display="block"}function loadComunidades(e=null){$.ajax({url:"../Controllers/Servlet.php?action=getComunidades",type:"GET",dataType:"json",success:function(o){if(o.error)console.log("No se encontraron comunidades.");else{var i=$("#inputComunidad");i.empty(),i.append('<option value="" disabled selected>Selecciona una comunidad autónoma</option>'),$.each(o.msg,(function(o,a){const n=a.id==e?"selected":"";i.append('<option value="0'+a.id+'" '+n+">"+a.nombre+"</option>")}))}},error:function(e,o,i){window.location.href="/500"}})}function loadProvincias(e=null,o=null){$.ajax({url:"../Controllers/Servlet.php?action=getProvincias&comunidadId="+e,type:"GET",dataType:"json",success:function(e){if(e.error)console.log("No se encontraron provincias.");else{var i=$("#inputProvincia");i.empty(),i.append('<option value="0" disabled selected>Selecciona una provincia</option>'),$.each(e.msg,(function(e,a){const n=a.id==o?"selected":"";i.append('<option value="'+a.id+'" '+n+">"+a.nombre+"</option>")}))}},error:function(e,o,i){window.location.href="/500"}})}function loadMunicipios(e=null,o=null){$.ajax({url:"../Controllers/Servlet.php?action=getMunicipios&provinciaId="+e,type:"GET",dataType:"json",success:function(e){if(e.error)console.log("No se encontraron municipios.");else{var i=$("#inputMunicipio");i.empty(),i.append('<option value="0" disabled selected>Selecciona un municipio</option>'),$.each(e.msg,(function(e,a){const n=a.id==o?"selected":"";i.append('<option value="'+a.id+'" '+n+">"+a.nombre+"</option>")}))}},error:function(e,o,i){window.location.href="/500"}})}function smartReload(e=""){localStorage.setItem("toastAction",e),location.reload()}$.ajax({url:"../Controllers/Servlet.php",type:"GET",data:{action:"getCampoUsr",campo:"idRol"},dataType:"text",success:function(e){1==e?($grid.isotope({filter:".mios"}),$('#registros option[value="1"], #registros option[value="3"]').remove(),$("#registros").prop("disabled",!0)):e>1&&e<5?($grid.isotope({filter:".unidad"}),$('#registros option[value="3"]').remove(),$("#registros").prop("disabled",!1)):5==e&&($grid.isotope({filter:".unidad"}),$("#registros").prop("disabled",!1)),toggleRamaOptions(!1),aplicarFiltros()},error:function(e,o,i){Swal.fire("Error","No se pudieron cargar los detalles.","error")}}),$(".rotate").on("click",(function(){$(this).closest(".card-body").find(".front, .back").toggleClass("d-none")})),$(".detallesBtn").on("click",(function(e){let o=e.target.getAttribute("data-id");$.ajax({url:"../Controllers/Servlet.php",type:"GET",data:{action:"getDetallesAsociado",idAsociado:o},dataType:"json",success:function(e){if(e.error)return void Swal.fire("Error","No se pudieron obtener los detalles.","error");let o=e.msg,i=`\n                <div style="text-align:left;">\n                    <h5>Datos del Niño</h5>\n                    <p><strong>Nombre:</strong> ${o.asociado.nombre}</p>\n                    <p><strong>Apellidos:</strong> ${o.asociado.apellidos}</p>\n                    <p><strong>Fecha de Nacimiento:</strong> ${o.asociado.fecha_nacimiento}</p>\n                    <p><strong>Edad:</strong> ${o.asociado.edad} años</p>\n                    <p><strong>Rama:</strong> ${o.asociado.unidad}</p>\n                    <p><strong>Municipio:</strong> ${o.asociado.municipio||"No disponible"}</p>\n                    <p><strong>Provincia:</strong> ${o.asociado.provincia||"No disponible"}</p>\n                    <p><strong>Comunidad Autónoma:</strong> ${o.asociado.comunidad_autonoma||"No disponible"}</p>\n\n                    <hr>\n\n                    <h5>Datos del Padre</h5>\n                    <p><strong>Nombre:</strong> ${o.padre.nombre}</p>\n                    <p><strong>Apellidos:</strong> ${o.padre.apellidos}</p>\n                    <p><strong>Correo:</strong> ${o.padre.correo}</p>\n                    <p><strong>Teléfono:</strong> ${o.padre.telefono}</p>\n                    <p><strong>Estado Civil:</strong> ${o.padre.estado_civil}</p>\n                </div>\n            `;Swal.fire({html:'\n                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">\n                        <h4 class="mb-0">Detalles del Asociado</h4>\n                        <button type="button" id="btnCloseModal" class="btn-close" aria-label="Cerrar"></button>\n                    </div>\n                    '+i,width:"600px",confirmButtonText:"Cerrar",customClass:{popup:"swal2-popup-custom"},didOpen:()=>{document.getElementById("btnCloseModal").addEventListener("click",(()=>{Swal.close()}))}})},error:function(){Swal.fire("Error","No se pudieron cargar los detalles.","error")}})})),$("#registros").on("change",(function(){const e=$(this).val();$("#searchAsociado").val(""),$("#ordenar").val("0"),$("#sinResultados").hide(),toggleRamaOptions(1!=e&&2!=e),aplicarFiltros()})),$("#ordenar").on("change",(function(){const e=$(this).val();$("#sinResultados").hide();let o="",i=!0;switch(e){case"0":return $("#closeFilters").hide(),$("#searchAsociado").val(""),$("#ordenar").val("0"),aplicarFiltros(),void $grid.isotope({sortBy:"original-order"});case"1":o="edad",i=!1;break;case"2":o="edad",i=!0;break;case"3":o="nombre",i=!0;break;case"4":o="nombre",i=!1;break;case"5":case"6":case"7":case"8":const a={5:"Lobatos",6:"Exploradores",7:"Pioneros",8:"Rutas"}[e];return $grid.isotope({filter:`[data-unidad="${a}"]`}),setTimeout((()=>{const e=$grid.data("isotope").filteredItems.length;$("#sinResultados").toggle(0===e)}),100),void $("#closeFilters").show()}$grid.isotope({sortBy:o,sortAscending:i}),$("#closeFilters").show()})),$("#searchAsociado").on("input",(function(){let e=document.getElementById("closeFilters");""==$("#searchAsociado").val().toLowerCase()?e.style.display="none":e.style.display="block";aplicarFiltros()})),$("#closeFilters").on("click",(function(){$("#ordenar").val("0"),$("#searchAsociado").val(""),$("#sinResultados").hide(),document.getElementById("closeFilters").style.display="none",aplicarFiltros()})),$("#resetSearchAsociado").on("click",(function(){$("#searchAsociado").val("");0==$("#ordenar").val()&&(document.getElementById("closeFilters").style.display="none"),aplicarFiltros()})),$(".editData").on("click",(function(e){let o=e.target.getAttribute("data-id");const i=Swal.mixin({toast:!0,position:"top",showConfirmButton:!1,timer:3e3,timerProgressBar:!0});Swal.fire({html:'\n                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">\n                    <h4 class="mb-0">Editar Datos</h4>\n                    <button type="button" id="btnCloseModal" class="btn-close" aria-label="Cerrar"></button>\n                </div>\n                <div style="text-align: center; margin-top: 10px;">\n                    <button type="button" class="btn btn-primary" id="guardarCambiosTop">Guardar</button>\n                </div>\n                <div id="editForm" style="text-align: left; padding: 10px;">Cargando datos...</div>\n                ',showCancelButton:!0,confirmButtonText:"Guardar Cambios",cancelButtonText:"Cancelar",width:"600px",customClass:{popup:"swal-wide"},focusConfirm:!1,didOpen:()=>{document.getElementById("btnCloseModal").addEventListener("click",(()=>{Swal.close()})),document.getElementById("guardarCambiosTop").addEventListener("click",(()=>{document.querySelector(".swal2-confirm")?.click()}));const e=Swal.getHtmlContainer();e.querySelector("#editForm").innerHTML=cargarLoader(),$.ajax({url:"../Controllers/Servlet.php",type:"GET",data:{action:"getDetallesAsociado",idAsociado:o},dataType:"json",success:function(o){if(o.error)return void(e.querySelector("#editForm").innerHTML="Error al cargar los detalles.");let i=o.msg,a=`\n                                        <h5>Datos del Niño</h5>\n                                        <div class="mb-2">\n                                            <label>Nombre:</label>\n                                            <input type="text" class="form-control" id="inputNombre" value="${i.asociado.nombre}" required>\n                                            <div class="invalid-feedback">El nombre es obligatorio</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Apellidos:</label>\n                                            <input type="text" class="form-control" id="inputApellidos" value="${i.asociado.apellidos}" required>\n                                            <div class="invalid-feedback">Los apellidos son obligatorios</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Fecha de Nacimiento:</label>\n                                            <input type="date" class="form-control" id="inputFechaNacimiento" value="${i.asociado.fecha_nacimiento}" required>\n                                            <div class="invalid-feedback" id="fechaErrorRama"></div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Edad:</label>\n                                            <input type="number" class="form-control" id="inputEdad" value="${i.asociado.edad}" disabled>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Rama:</label>\n                                            <input type="text" class="form-control" id="inputUnidad" value="${i.asociado.unidad}" disabled>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Comunidad Autónoma</label>\n                                            <select id="inputComunidad" class="form-control" required></select>\n                                            <div class="invalid-feedback">Selecciona una comunidad</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Provincia</label>\n                                            <select id="inputProvincia" class="form-control" required></select>\n                                            <div class="invalid-feedback">Selecciona una provincia</div>\n                                        </div>\n                                        <div class="mb-3">\n                                            <label>Municipio</label>\n                                            <select id="inputMunicipio" class="form-control" required></select>\n                                            <div class="invalid-feedback">Selecciona un municipio</div>\n                                        </div>\n                                    \n                                        <hr>\n                                        <h5>Datos del Padre</h5>\n                                        <div class="mb-2">\n                                            <label>Nombre:</label>\n                                            <input type="text" class="form-control" id="inputPadreNombre" value="${i.padre.nombre}" required>\n                                            <div class="invalid-feedback">El nombre del padre es obligatorio</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Apellidos:</label>\n                                            <input type="text" class="form-control" id="inputPadreApellidos" value="${i.padre.apellidos}" required>\n                                            <div class="invalid-feedback">Los apellidos del padre son obligatorios</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Correo:</label>\n                                            <input type="email" class="form-control" id="inputPadreCorreo" value="${i.padre.correo}" required>\n                                            <div class="invalid-feedback">Correo inválido</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Teléfono:</label>\n                                            <input type="text" class="form-control" id="inputPadreTelefono" value="${i.padre.telefono}" required>\n                                            <div class="invalid-feedback">El teléfono es obligatorio</div>\n                                        </div>\n                                        <div class="mb-2">\n                                            <label>Estado Civil:</label>\n                                            <input type="text" class="form-control" id="inputPadreEstadoCivil" value="${i.padre.estado_civil}" required>\n                                            <div class="invalid-feedback">Este campo es obligatorio</div>\n                                        </div>\n                                    `;e.querySelector("#editForm").innerHTML=a,loadAddresses(i.asociado.comunidad_autonomaId,i.asociado.provinciaId,i.asociado.municipioId),Swal.__initialValues={idAsociado:i.asociado.id_ins,nombre:i.asociado.nombre,apellidos:i.asociado.apellidos,fecha_nacimiento:i.asociado.fecha_nacimiento,edad:i.asociado.edad,unidad:i.asociado.unidad,comunidadId:i.asociado.comunidad_autonomaId,provinciaId:i.asociado.provinciaId,municipioId:i.asociado.municipioId,padreId:i.padre.id,padreNombre:i.padre.nombre,padreApellidos:i.padre.apellidos,padreCorreo:i.padre.correo,padreTelefono:i.padre.telefono,padreEstadoCivil:i.padre.estado_civil}},error:()=>{e.querySelector("#editForm").innerHTML="Error al obtener los datos."}})},preConfirm:()=>{if(!function(){let e=!0;return["inputNombre","inputApellidos","inputFechaNacimiento","inputComunidad","inputProvincia","inputMunicipio","inputPadreNombre","inputPadreApellidos","inputPadreCorreo","inputPadreTelefono","inputPadreEstadoCivil"].forEach((o=>{const i=document.getElementById(o);if(!i)return;const a=i.value.trim();if("inputPadreCorreo"===o){/^[^@]+@[^@]+\.[a-z]{2,}$/.test(a)?i.classList.remove("is-invalid"):(i.classList.add("is-invalid"),e=!1)}else a?i.classList.remove("is-invalid"):(i.classList.add("is-invalid"),e=!1)})),e}())return Swal.showValidationMessage("Hay campos obligatorios no rellenados o inválidos"),!1;const e=Swal.__initialValues,o={nombre:$("#inputNombre").val(),apellidos:$("#inputApellidos").val(),fecha_nacimiento:$("#inputFechaNacimiento").val(),edad:$("#inputEdad").val(),unidad:$("#inputUnidad").val(),comunidadId:$("#inputComunidad").val(),provinciaId:$("#inputProvincia").val(),municipioId:$("#inputMunicipio").val(),padreNombre:$("#inputPadreNombre").val(),padreApellidos:$("#inputPadreApellidos").val(),padreCorreo:$("#inputPadreCorreo").val(),padreTelefono:$("#inputPadreTelefono").val(),padreEstadoCivil:$("#inputPadreEstadoCivil").val()},a={};for(let i in o)o[i]!==String(e[i])&&(a[i]=o[i]);return 0===Object.keys(a).length?(i.fire({icon:"info",title:"No se han detectado cambios"}),!1):$.ajax({url:"../Controllers/Servlet.php",type:"POST",data:{action:"updateAsociadoYPadre",asociado:{idAsociado:e.idAsociado,nombre:a.nombre||e.nombre,apellidos:a.apellidos||e.apellidos,fecha_nacimiento:a.fecha_nacimiento||e.fecha_nacimiento,edad:a.edad||e.edad,unidad:a.unidad||e.unidad,comunidadId:a.comunidadId||e.comunidadId,provinciaId:a.provinciaId||e.provinciaId,municipioId:a.municipioId||e.municipioId},padre:{idPadre:e.padreId,nombre:a.padreNombre||e.padreNombre,apellidos:a.padreApellidos||e.padreApellidos,correo:a.padreCorreo||e.padreCorreo,telefono:a.padreTelefono||e.padreTelefono,estadoCivil:a.padreEstadoCivil||e.padreEstadoCivil}},dataType:"json"}).then((e=>{if(!e.success)throw new Error("Error en actualización");return e})).catch((e=>{Swal.showValidationMessage(`Error: ${e.message}`)}))}}).then((e=>{e.isConfirmed&&e.value&&e.value.success&&smartReload("edit")}))})),$(".deleteData").on("click",(function(e){let o=e.target.getAttribute("data-id"),i=e.target.getAttribute("data-idP");$.ajax({url:"../Controllers/Servlet.php",type:"GET",data:{action:"getCampo",campo:"nombreCompleto",idAsociado:o},dataType:"text",success:function(e){Swal.fire({title:"¿Eliminar Asociado?",html:`¿Estás seguro de que deseas eliminar a <strong>${e}</strong>?`,icon:"warning",showCancelButton:!0,confirmButtonText:"Eliminar",cancelButtonText:"Cancelar",reverseButtons:!0,customClass:{popup:"swal2-popup-custom"}}).then((e=>{e.isConfirmed&&$.ajax({url:"../Controllers/Servlet.php",type:"POST",data:{action:"deleteAsociado",idAsociado:o,idPadre:i},dataType:"json",success:function(e){e.success?smartReload("delete"):Swal.fire("Error","No se pudo eliminar el asociado.","error")},error:function(){Swal.fire("Error","Error de red al intentar eliminar.","error")}})}))},error:function(){Swal.fire("Error","No se pudo obtener el nombre del asociado.","error")}})})),jQuery((function(){const e=localStorage.getItem("toastAction");if(e){let o="",i="success";"edit"===e?o="Datos actualizados correctamente":"delete"===e?o="Asociado eliminado correctamente":"new"===e&&(o="Asociado creado correctamente"),o&&Swal.fire({toast:!0,position:"top",icon:i,title:o,showConfirmButton:!1,timer:3e3,timerProgressBar:!0}),localStorage.removeItem("toastAction")}}));