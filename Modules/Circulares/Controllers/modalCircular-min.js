function openCircularModal(e="crear",a={}){const i="editar"===e,t="clonar"===e;Swal.fire({title:i?"Editar circular":t?"Clonar circular":"Crear nueva circular",width:600,html:`\n            <form id="formNuevaCircular" class="createModal">\n                <div class="mb-2">\n                    <input type="hidden" id="id" value="${a.id||""}">\n                </div>\n                <div class="mb-2">\n                    <label for="titulo">Título:</label>\n                    <input type="text" class="form-control" id="titulo" required>\n                    <div class="invalid-feedback">El título es obligatorio.</div>\n                </div>\n\n                <div class="mb-2">\n                    <label for="fechaInicio">Fecha de inicio:</label>\n                    <input type="date" class="form-control" id="fechaInicio" required>\n                    <div class="invalid-feedback">Fecha de inicio requerida.</div>\n                </div>\n\n                <div class="mb-2">\n                    <label for="fechaFin">Fecha de fin:</label>\n                    <input type="date" class="form-control" id="fechaFin" required>\n                    <div class="invalid-feedback" id="errorFechaNoValida">Fecha de fin requerida.</div>\n                </div>\n\n                <div class="mb-2" id="pernoctaContainer" style="display: none;">\n                    <label for="pernoctas">¿Cuántas pernoctas?</label>\n                    <input type="number" class="form-control" id="pernoctas" min="0" readonly>\n                    <div class="invalid-feedback">Indica número de pernoctas.</div>\n                </div>\n\n                <div class="mb-2">\n                    <label for="ubicacion">Ubicación:</label>\n                    <input type="text" class="form-control" id="ubicacion" required>\n                    <div class="invalid-feedback">La ubicación es obligatoria.</div>\n                </div>\n\n                <div class="mb-2">\n                    <label for="rama">Rama:</label>\n                    <select class="form-control" id="rama" required>\n                        <option value="">Selecciona una rama</option>\n                        <option value="Lobatos">Lobatos</option>\n                        <option value="Exploradores">Exploradores</option>\n                        <option value="Pioneros">Pioneros</option>\n                        <option value="General">General</option>\n                    </select>\n                    <div class="invalid-feedback">La rama es obligatoria.</div>\n                </div>\n\n                <div class="mb-3">\n                    <label for="archivo">Archivo PDF:</label>\n                    <div class="fileUploader">\n                        <div class="header">\n                            <i class="fa fa-file-upload"></i>\n                            <p>Sube el archivo PDF</p>\n                        </div>\n                        <div class="footer">\n                            <i class="fa fa-file-upload" id="archivoIcono"></i>\n                            <p id="archivoNombre">Ningún archivo seleccionado</p>\n                            <i class="fa fa-trash" id="archivoEliminar" style="display: none;"></i>\n                        </div>\n                        <input id="inputFileId" type="file" accept="application/pdf" style="display: none;">\n                    </div>\n                    <div class="invalid-feedback" id="errorFileInput">Selecciona un archivo PDF.</div>\n                </div>\n            </form>\n        `,confirmButtonText:i?"Guardar cambios":t?"Clonar circular":"Subir circular",showCancelButton:!0,didOpen:()=>{if(function(){const e=document.getElementById("inputFileId"),a=document.getElementById("archivoIcono"),i=document.getElementById("archivoNombre"),t=document.getElementById("archivoEliminar"),n=document.querySelector(".fileUploader");function l(n){a.classList.remove("fa-file-upload","fa-arrow-circle-right"),a.classList.add("fa-file-pdf"),i.textContent=n.name,t.style.display="inline",e.classList.add("is-valid")}function o(){e.value="",e.removeAttribute("data-existing"),a.classList.remove("fa-file-pdf","fa-arrow-circle-right"),a.classList.add("fa-file-upload"),i.textContent="Ningún archivo seleccionado",t.style.display="none",e.classList.remove("is-valid"),n.classList.remove("drag-over")}if(n.addEventListener("click",(a=>{a.target.closest("#archivoEliminar")||e.click()})),e.addEventListener("change",(e=>{e.target.files.length>0?l(e.target.files[0]):o()})),t.addEventListener("click",(e=>{e.stopPropagation(),o()})),n.addEventListener("dragover",(e=>{e.preventDefault(),a.classList.remove("fa-file-upload"),a.classList.add("fa-arrow-circle-right"),i.textContent="¡Suelta el archivo aquí!",n.classList.add("drag-over")})),n.addEventListener("dragleave",(()=>{a.classList.remove("fa-arrow-circle-right"),a.classList.add("fa-file-upload"),i.textContent=e.files.length?e.files[0].name:"Ningún archivo seleccionado",n.classList.remove("drag-over")})),n.addEventListener("drop",(t=>{t.preventDefault(),n.classList.remove("drag-over"),a.classList.remove("fa-arrow-circle-right"),t.dataTransfer.files.length>0?(e.files=t.dataTransfer.files,l(t.dataTransfer.files[0])):(a.classList.add("fa-file-upload"),i.textContent="Ningún archivo seleccionado")})),e.files.length>0){const n=e.files[0];a.classList.remove("fa-file-upload"),a.classList.add("fa-file-pdf"),i.textContent=n.name,t.style.display="inline",e.classList.add("is-valid")}}(),function(){const e=document.getElementById("fechaInicio"),a=document.getElementById("fechaFin"),i=document.getElementById("pernoctaContainer"),t=document.getElementById("pernoctas"),n=(new Date).toISOString().split("T")[0];function l(){const n=new Date(e.value),l=new Date(a.value);if(e.classList.remove("is-invalid","is-valid"),a.classList.remove("is-invalid","is-valid"),e.value?e.classList.add("is-valid"):(e.classList.add("is-invalid"),$("#errorFechaNoValida").text("Fecha de fin requerida")),a.value?l<n?(a.classList.add("is-invalid"),$("#errorFechaNoValida").text("La fecha de fin no puede ser menor que la de inicio")):a.classList.add("is-valid"):(a.classList.add("is-invalid"),$("#errorFechaNoValida").text("Fecha de fin requerida")),l>n){i.style.display="block";const e=Math.ceil((l-n)/864e5);t.value=e}else i.style.display="none"}e.setAttribute("min",n),a.setAttribute("min",n),e.addEventListener("change",l),a.addEventListener("change",l)}(),(i||t)&&(document.getElementById("titulo").value=a.titulo||"",document.getElementById("fechaInicio").value=a.fechaInicio||"",document.getElementById("fechaFin").value=a.fechaFin||"",document.getElementById("pernoctas").value=a.pernoctas||0,document.getElementById("ubicacion").value=a.ubicacion||"",document.getElementById("rama").value=a.rama||""),i&&a.path){const e=document.getElementById("archivoIcono"),i=document.getElementById("archivoNombre"),t=document.getElementById("archivoEliminar"),n=document.getElementById("inputFileId");e.classList.remove("fa-file-upload"),e.classList.add("fa-file-pdf"),i.textContent=a.path.split("/").pop(),t.style.display="inline",n.classList.add("is-valid"),n.dataset.existing="true"}},preConfirm:()=>{let e=!0;["titulo","fechaInicio","fechaFin","rama","ubicacion"].forEach((a=>{const i=document.getElementById(a);i.value.trim()?i.classList.remove("is-invalid"):(i.classList.add("is-invalid"),e=!1)}));const a=document.getElementById("fechaInicio"),t=document.getElementById("fechaFin"),n=new Date(a.value);new Date(t.value)<n?(e=!1,t.classList.add("is-invalid"),$("#errorFechaNoValida").text("La fecha de fin no puede ser menor que la de inicio")):t.classList.remove("is-invalid");const l=document.getElementById("inputFileId"),o=l.files.length>0,r="true"===l.dataset.existing;if(o||r)if(o){l.files[0].size>20971520?(l.classList.add("is-invalid"),$("#errorFileInput").text("El archivo excede el tamaño máximo de 20 MB.").show(),e=!1):(l.classList.remove("is-invalid"),$("#errorFileInput").hide())}else l.classList.remove("is-invalid"),$("#errorFileInput").hide();else l.classList.add("is-invalid"),$("#errorFileInput").text("Debes seleccionar un archivo.").show(),e=!1;if(!e)return Swal.showValidationMessage("Por favor, corrige los errores del formulario."),!1;const s=new FormData;return s.append("titulo",document.getElementById("titulo").value.trim()),s.append("fecha_inicio",document.getElementById("fechaInicio").value),s.append("fecha_fin",document.getElementById("fechaFin").value),s.append("pernoctas",document.getElementById("pernoctas").value||0),s.append("ubicacion",document.getElementById("ubicacion").value),s.append("rama",document.getElementById("rama").value),i&&s.append("id_file",document.getElementById("id").value),o&&s.append("archivo",l.files[0]),r&&s.append("archivoExistente","true"),Swal.showLoading(),$.ajax({url:"../Controllers/Servlet.php?action="+(i?"editCircular":"createCircular"),type:"POST",data:s,contentType:!1,processData:!1,dataType:"json"})}}).then((e=>{e?e.value.error?Swal.fire({title:"Error",text:e.value.message||"Ocurrió un error.",icon:"error",showCancelButton:!0,confirmButtonText:"Volver a intentar",cancelButtonText:"Cancelar",customClass:{icon:"mi-popup-central"}}).then((a=>{if(a.isConfirmed){openCircularModal(i?"editar":t?"clonar":"crear",e.value.reintentoDatos||{})}})):Swal.fire({title:"¡Circular guardada!",text:e.value.message||"La circular se ha guardado correctamente.",icon:"success",timer:2e3,showConfirmButton:!1,customClass:{icon:"mi-popup-central"}}).then((()=>{Swal.close(),location.reload()})):Swal.fire("Error","No se recibió respuesta del servidor.","error")}))}