function loadUsersData(o){$.ajax({url:"../Controllers/Servlet.php?action=getUsers",type:"GET",dataType:"html",success:function(a){let e;try{e=JSON.parse(a)}catch(o){e=null}if(e&&e.sesion)return void(window.location.href="/403");const r=$("#tablaUsuarios");$.fn.DataTable.isDataTable(r)&&r.DataTable().destroy(),$("#userTableBody").html(a),loadTable(),o&&loadCosas()},error:function(o,a,e){console.error("Error al cargar los datos de los usuarios:",e),$("#userTableBody").html('<tr><td colspan="7" class="text-center">Error al cargar los usuarios</td></tr>')}})}function loadTable(){$("#tablaUsuarios").DataTable({language:{url:"//cdn.datatables.net/plug-ins/1.13.6/i18n/es-ES.json",zeroRecords:"No se encontraron resultados.",emptyTable:"No hay usuarios disponibles."},responsive:!0,orderCellsTop:!0,initComplete:function(){let o=this.api();const a={1:"Padre",2:"Monitor",3:"Secretario Unidad",4:"Coordinador Unidad",5:"Admin"};$("#filter-rol").on("change",(function(){const e=this.value,r=a[e]||"";o.column(0).search(r).draw()})),$("#filter-rama").on("change",(function(){o.column(1).search(this.value).draw()}))},columnDefs:[{targets:0,render:function(o,a,e,r){return"filter"===a||"sort"===a?$("<div>").html(o).find(".display-rol").text():o}},{targets:1,render:function(o,a,e,r){return"filter"===a||"sort"===a?$("<div>").html(o).find(".display-rama").text():o}}]})}function loadCosas(){function o(){setTimeout(a,50)}function a(){let o=!1;$("#tablaUsuarios tbody tr").each((function(){const a=$(this),e=a.find(".edit-rol"),r=a.find(".edit-rama"),s=parseInt(e.data("original")),t=r.data("original"),i=parseInt(e.val()),l=r.val();let n=!1;i!==s&&(n=!0),r.prop("disabled")||l===String(t)||(n=!0),n?(o=!0,a.addClass("modificado")):a.removeClass("modificado")})),toggleGuardarBtn()}$("#tablaUsuarios").on("click",".display-rol",(function(){const a=$(this),e=a.siblings(".edit-rol");a.addClass("d-none"),e.removeClass("d-none").focus(),o()})),$("#tablaUsuarios").on("change",".edit-rol",(function(){const a=$(this),e=a.find("option:selected").text();a.siblings(".display-rol").text(e).removeClass("d-none"),a.addClass("d-none");const r=a.closest("tr"),s=r.find(".edit-rama"),t=r.find(".display-rama");"Padre"!==e?(s.prop("disabled",!1).removeClass("d-none"),t.addClass("d-none")):(s.val("0"),s.prop("disabled",!0).addClass("d-none"),t.removeClass("d-none").text("")),"Padre"===e&&(s.removeClass("is-invalid"),r.removeClass("fila-error")),o()})),$("#tablaUsuarios").on("focusout",".edit-rol",(function(){const a=$(this);setTimeout((()=>{if(!a.is(":focus")){const e=a.siblings(".display-rol"),r=a.find("option:selected").text();e.text(r).removeClass("d-none"),a.addClass("d-none"),o()}}),150)})),$("#tablaUsuarios").on("click",".display-rama",(function(){const a=$(this),e=a.siblings(".edit-rama");e.is(":disabled")||(a.addClass("d-none"),e.removeClass("d-none").focus(),o())})),$("#tablaUsuarios").on("change",".edit-rama",(function(){const a=$(this),e=a.find("option:selected").text(),r=a.siblings(".display-rama"),s=a.closest("tr");r.text(e).removeClass("d-none"),a.addClass("d-none"),"0"!==a.val()&&a.val()&&(a.removeClass("is-invalid"),s.removeClass("fila-error")),o()})),$("#tablaUsuarios").on("focusout",".edit-rama",(function(){const a=$(this);setTimeout((()=>{if(!a.is(":focus")){const e=a.siblings(".display-rama"),r=a.find("option:selected").text();e.text(r).removeClass("d-none"),a.addClass("d-none"),o()}}),150)}))}function toggleGuardarBtn(){const o=$("#tablaUsuarios tbody tr.modificado").length>0;$("#guardarCambios").prop("disabled",!o),$("#filtrarModificados").prop("disabled",!o)}jQuery((function(){loadUsersData(!0)}));let mostrandoSoloModificados=!1;$("#filtrarModificados").on("click",(function(){mostrandoSoloModificados?($("#tablaUsuarios tbody tr").show(),$(this).html('<i class="fas fa-filter"></i> Ver cambios')):($("#tablaUsuarios tbody tr").not(".modificado").hide(),$(this).html('<i class="fas fa-filter"></i> Ver Todo')),mostrandoSoloModificados=!mostrandoSoloModificados})),$("#guardarCambios").on("click",(function(){const o=[];let a=!1;$("#tablaUsuarios tbody tr.modificado").each((function(){const e=$(this),r=e.data("id"),s=parseInt(e.find(".edit-rol").val()),t=e.find(".edit-rama"),i=t.val();if(e.removeClass("fila-error"),t.removeClass("is-invalid"),1!==s&&("0"===i||!i))return t.addClass("is-invalid"),e.addClass("fila-error"),t.trigger("focus"),a=!0,!1;o.push({id:r,rol:s,rama:i})})),a||0===o.length||Swal.fire({title:"¬øQuieres guardar los datos?",html:"Los usuarios que <strong>no tengan rol de Padre</strong> y hayan sido modificados ser√°n notificados por <strong>correo electr√≥nico</strong> del cambio realizado.",icon:"question",showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",reverseButtons:!0}).then((a=>{a.isConfirmed&&$.ajax({url:"../Controllers/Servlet.php",method:"POST",data:{action:"updateUsersRol",cambios:JSON.stringify(o)},success:function(o){if(o.error){let a='<ul style="text-align: left;">'+o.msg+"</ul>";Swal.fire({icon:"error",title:"Error al notificar",html:`\n                    <p>Hubo errores al enviar las notificaciones por correo electr√≥nico:</p>\n                    ${a}\n                `,confirmButtonText:"OK",customClass:{popup:"swal-wide"}})}else $("#tablaUsuarios tbody tr.modificado").removeClass("modificado fila-error").css("transition","background-color 0.4s").css("background-color","#d4edda"),toggleGuardarBtn(),loadUsersData(!1),setTimeout((()=>{$("#tablaUsuarios tbody tr").css("background-color","")}),1e3),Swal.fire({toast:!0,position:"top",icon:"success",title:"Cambios de rol guardados correctamente",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})},error:function(o){console.error("Error guardando:",o),Swal.fire({toast:!0,position:"top",icon:"error",title:"Error al guardar los cambios de rol",showConfirmButton:!1,timer:3e3,timerProgressBar:!0})}})}))})),$(document).on("click",".edit-user",(function(){openEditUserSwal({id:$(this).data("id"),nombre:$(this).data("nombre"),apellidos:$(this).data("apellidos"),correo:$(this).data("correo"),tel:$(this).data("tel"),rol:$(this).data("rol"),rama:$(this).data("rama")})}));let userDataEdited=null;function openEditUserSwal(o){Swal.fire({title:"Editar Usuario",html:`\n        <form id="swalEditForm" class="text-start">\n          <input type="hidden" id="userId" value="${o.id}">\n  \n          <div class="mb-3">\n            <label for="nombre" class="form-label">Nombre</label>\n            <input type="text" class="form-control" id="nombre" name="nombre" value="${o.nombre}">\n          </div>\n  \n          <div class="mb-3">\n            <label for="apellidos" class="form-label">Apellidos</label>\n            <input type="text" class="form-control" id="apellidos" name="apellidos" value="${o.apellidos}">\n          </div>\n  \n          <div class="mb-3" id="divCorreo">\n            <label for="correo" class="form-label">Correo</label>\n            <input type="email" class="form-control" id="correo" name="correo" value="${o.correo}" readonly>\n          </div>\n  \n          <div class="mb-3" id="divTelefono">\n            <label for="telefono" class="form-label">Tel√©fono</label>\n            <input type="text" class="form-control" id="telefono" name="telefono" value="${o.tel||o.telefono}" readonly>\n          </div>\n  \n          <div class="mb-3">\n            <label for="password" class="form-label">Contrase√±a (opcional)</label>\n            <div class="input-group">\n              <input type="password" class="form-control" id="password" name="password" value="${o.password?o.password:""}" placeholder="Nueva contrase√±a">\n              <button class="btn btn-outline-secondary" type="button" id="togglePassword">\n                üëÅÔ∏è\n              </button>\n            </div>\n          </div>\n  \n          <div class="mb-3">\n            <label for="rol" class="form-label">Rol</label>\n            <select class="form-select" id="rol" name="rol">\n              <option value="1" ${1==o.rol?"selected":""}>Padre</option>\n              <option value="2" ${2==o.rol?"selected":""}>Monitor</option>\n              <option value="3" ${3==o.rol?"selected":""}>Secretario Unidad</option>\n              <option value="4" ${4==o.rol?"selected":""}>Coordinador Unidad</option>\n              <option value="5" ${5==o.rol?"selected":""}>Admin</option>\n            </select>\n          </div>\n  \n          <div class="mb-3">\n            <label for="rama" class="form-label">Rama</label>\n            <select class="form-select" id="rama" name="rama">\n              <option value="">Seleccione rama</option>\n              <option value="Lobatos" ${"Lobatos"==o.rama?"selected":""}>Lobatos</option>\n              <option value="Exploradores" ${"Exploradores"==o.rama?"selected":""}>Exploradores</option>\n              <option value="Pioneros" ${"Pioneros"==o.rama?"selected":""}>Pioneros</option>\n              <option value="Rutas" ${"Rutas"==o.rama?"selected":""}>Rutas</option>\n            </select>\n          </div>\n        </form>\n      `,showCancelButton:!0,confirmButtonText:"Guardar cambios",cancelButtonText:"Cancelar",focusConfirm:!1,customClass:{popup:"swal-wide no-icon"},didOpen:()=>{$("#rol").on("change",updateRamaValidation),updateRamaValidation(),$("#telefono, #correo").on("click",(function(){const o=$(this);o.hasClass("is-invalid")||(o.removeClass("is-valid").addClass("is-invalid"),0===o.next(".invalid-feedback").length&&o.after('<div class="invalid-feedback">Solo el propio usuario puede modificar este dato.</div>'))})),$("#togglePassword").on("click",(function(){const o=$("#password"),a=o.attr("type");o.attr("type","password"===a?"text":"password")})),$.validator.addMethod("requiredIfRolSuperior",(function(o,a){return"1"===$("#rol").val()||""!==o}),"Debe seleccionar una rama para ese rol."),$("#swalEditForm").validate({ignore:"#correo, #telefono",rules:{nombre:{required:!0},apellidos:{required:!0},rol:{required:!0},rama:{requiredIfRolSuperior:!0}},messages:{nombre:"Introduce un nombre",apellidos:"Introduce los apellidos"},errorClass:"is-invalid",validClass:"is-valid",errorPlacement:function(o,a){o.insertAfter(a)}})},preConfirm:()=>{if(!$("#swalEditForm").valid())return Swal.showValidationMessage("Por favor, corrige los errores antes de continuar"),!1;const o={id:$("#userId").val(),nombre:$("#nombre").val(),apellidos:$("#apellidos").val(),correo:$("#correo").val(),telefono:$("#telefono").val(),password:$("#password").val(),rol:$("#rol").val(),rama:$("#rama").val()};return userDataEdited=o,o}}).then((o=>{o.isConfirmed&&o.value&&Swal.fire({title:"¬øQuieres guardar los datos?",html:"Los usuarios que <strong>no tengan rol de Padre</strong> y hayan sido modificados ser√°n notificados por <strong>correo electr√≥nico</strong> del cambio realizado.",icon:"question",showCancelButton:!0,confirmButtonText:"Guardar",cancelButtonText:"Cancelar",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",reverseButtons:!0}).then((o=>{o.isConfirmed?saveTotalData(userDataEdited):openEditUserSwal(userDataEdited)}))}))}function updateRamaValidation(){"1"===$("#rol").val()?($("#rama").val("").prop("disabled",!0).removeClass("is-invalid is-valid"),$('label[for="rama"]').text("Rama (no aplica para Padres)")):($("#rama").prop("disabled",!1),$('label[for="rama"]').text("Rama"),""===$("#rama").val()&&$("#rama").addClass("is-invalid"))}function saveTotalData(o){const a=""!==o.password.trim();Swal.fire({title:"Guardando cambios...",text:"Por favor, espera un momento.",allowOutsideClick:!1,allowEscapeKey:!1,didOpen:()=>{Swal.showLoading()}}),$.ajax({url:"../Controllers/Servlet.php",type:"POST",dataType:"json",data:{action:"updateData",profile:!1,...o},success:function(o){o.success?(Swal.fire({toast:!0,icon:"success",position:"top",title:a?"Usuario actualizado y contrase√±a enviada":"Usuario actualizado con √©xito",showConfirmButton:!1,timer:3e3,timerProgressBar:!0}),loadUsersData(!1)):Swal.fire("Error",o.message||"No se pudo actualizar el usuario","error")},error:function(o){console.error(o),Swal.fire("Error","Error de servidor","error")}})}$(document).on("click",".delete-user",(function(){const o=$(this).data("id");Swal.fire({title:"¬øEst√°s seguro?",text:"El usuario ser√° eliminadoger4t4.",icon:"warning",showCancelButton:!0,confirmButtonText:"S√≠, eliminar",cancelButtonText:"Cancelar"}).then((a=>{a.isConfirmed&&$.ajax({url:"../Controllers/Servlet.php",type:"POST",data:{action:"deleteUser",id:o},dataType:"json",success:function(o){o.success?(Swal.fire("Desactivado",o.message,"success"),loadUsersData(!1)):Swal.fire("Error",o.message,"error")},error:function(){Swal.fire("Error","No se pudo completar la solicitud.","error")}})}))}));